/**
 * Detail Preview Extension for PHPMaker 2021
 * @license Copyright (c) e.World Technology Limited. All rights reserved.
 */
ew.PREVIEW_LOADING_HTML='<div class="'+ew.spinnerClass+' m-3 ew-loading" role="status"><span class="sr-only">'+ew.language.phrase("Loading")+"</span></div>",ew.PREVIEW_BUTTON_SELECTOR=".ew-preview-row-btn",ew.PREVIEW_OVERLAY_WIDTH=1e3,ew.addRowToTable=function(e){var t,a=jQuery,o=a(e),r=0,i=o.closest("tbody");ew.PREVIEW_SINGLE_ROW&&i.find("tr.ew-table-preview-row").remove(),a(e.cells).each((function(){r+=this.colSpan}));var n=o.nextAll("tr[data-rowindex!="+o.data("rowindex")+"]").first();return n.hasClass("ew-table-preview-row")?n[0]:((t=i[0].insertRow(n[0]?n[0].sectionRowIndex:-1))&&(a(t).addClass("ew-table-preview-row"),a(t.insertCell(0)).addClass("ew-table-last-col").prop("colSpan",r)),t)},ew.showDetails=function(e){var t=jQuery,a=t(this),o=a.is("tr[data-rowindex]")?a:a.closest("tr[data-rowindex]"),r=o.closest("table");if(o[0]){if(o.data("preview")){var i=o.nextAll("tr[data-rowindex!='"+o.data("rowindex")+"']").first();i.hasClass("ew-table-preview-row")&&i.remove(),o.data("preview",!1).find(ew.PREVIEW_BUTTON_SELECTOR).addClass("icon-expand").removeClass("icon-collapse")}else{var n=t(ew.addRowToTable(o[0]).cells[0]),d=o.find("[class$=_preview] div.ew-preview");n.empty(),n.append(t("#ew-preview").contents().clone()).find(".nav-tabs").append(d.find("li:has([data-toggle='tab'])").clone(!0)).find("[data-toggle='tab']").attr("data-target","#"+n.find(".tab-pane").attr("id",ew.random()).attr("id")).first().tab("show"),(ew.PREVIEW_SINGLE_ROW?r:o).find(ew.PREVIEW_BUTTON_SELECTOR).addClass("icon-expand").removeClass("icon-collapse"),o.data("preview",!0).find(ew.PREVIEW_BUTTON_SELECTOR).addClass("icon-collapse").removeClass("icon-expand")}ew.setupTable(-1,r[0],!0),!1===o.data("preview")&&ew.fixLayoutHeight()}},ew.detail=function(e,t){var a=jQuery,o=a(t),r=o.closest(".ew-list-option-body"),i=o.data("placement")||ew.PREVIEW_PLACEMENT,n=r.find(".dropdown-menu"),d=r.find(".btn-group");if(n.mouseenter((function(e){e.stopPropagation()})),d[0]&&("right"==i&&n.addClass("float-right"),o=d.first()),!o.data("bs.popover")){o.popover({html:!0,delay:{show:100,hide:250},placement:i,trigger:"hover",container:a("#ew-tooltip")[0],content:ew.PREVIEW_LOADING_HTML,sanitizeFn:ew.sanitizeFn}).on("shown.bs.popover",(function(e){var t=ew.PREVIEW_OVERLAY_WIDTH,n=a(o.data("bs.popover").getTipElement()).css("max-width",t+"px");if("left"==i){var d=o.closest(".btn-group").offset();n.css({"min-width":t+"px",transform:"none",left:d.left-t-n.find(".arrow").width(),top:d.top})}else n.css("min-width","200px");n.find(".popover-body").html(a("#ew-preview").html()),n.find(".nav-tabs").append(r.find("li:has([data-toggle='tab'])").clone(!0)),n.find("[data-toggle='tab']").attr("data-target","#"+n.find(".tab-pane").attr("id",ew.random()).attr("id")).data("$element",o).first().tab("show")}));var s=o.data("bs.popover");a(s.getTipElement()).on("mouseenter",(function(e){clearTimeout(s._timeout)})).on("mouseleave",(function(e){a(s.getTipElement()).html().includes(ew.PREVIEW_LOADING_HTML)||(s._timeout=setTimeout((function(){s.hide()}),s.config.delay.hide))}))}},ew.tabShow=function(e){var t,a,o,r,i,n=jQuery,d=n(e.currentTarget),s=d.data("target"),l=n(s),w=d.data("table"),p="";l[0]&&(d.data("url")?((t=l.data(w)||{}).url=i=d.data("url"),a=t.start||1,o=t.sort,r=t.sortOrder):d.data("start")?(d.tooltip&&d.tooltip("hide"),t=l.data(w),i=t.url,t.start=a=d.data("start")||1,o=t.sort,r=t.sortOrder):d.data("sort")&&(t=l.data(w),i=t.url,a=t.start||1,t.sort=o=d.data("sort"),t.sortOrder=r=d.data("sortOrder"),o===t.sort&&r===t.sortOrder||(t.start=a=1,t.sortOrder=r="")),l.data(w,t).empty().html(ew.PREVIEW_LOADING_HTML),n.isNumber(a)&&(p+="&start="+a),o&&(p+="&sort="+encodeURIComponent(o),["ASC","DESC","NO"].includes(r)&&(p+="&sortorder="+r),e.shiftKey&&!e.ctrlKey?p+="&cmd=resetsort":e.ctrlKey&&2==d.data("sortType")&&(p+="&ctrl=1")),n.get(i+p,(function(e){l.empty().html(e).append(n("div[data-table='"+w+"'][data-url='"+i+"']:first").clone()),l.find(".ew-pager .btn:not(.disabled), .ew-table-header > th > div[data-sort]").data({target:s,table:w}).on("click",ew.tabShow),n(document).trigger("preview",[{$tabpane:l}])})))},ew.preview=function(e,t){var a=jQuery,o=t.$tabpane;e=a.Event("preview",{target:o});ew.lazyLoad(e),ew.initGridPanels(),o.find("table.ew-table").each(ew.setupTable),ew.initTooltips(e),ew.initLightboxes(e),ew.initIcons(e),ew.fixLayoutHeight()},jQuery((function(e){e(document).on("preview",ew.preview),ew.PREVIEW_OVERLAY&&e("div.ew-preview").each((function(){e(this).parent().find("[data-action='view'],[data-action='list']").each(ew.detail)})),e(ew.PREVIEW_BUTTON_SELECTOR).on("click",ew.showDetails),e("div.ew-preview [data-toggle='tab']").on("show.bs.tab",ew.tabShow)}));